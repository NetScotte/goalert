[
  {
    "Name": "Backend",
    "Before": {
      "Name": "Prep",
      "Dir": "web/src",
      "Command": ["./scripts/smoketest-prep.sh"],
      "Env": [
        "DB_URL=$DB_URL",
        "GOALERT=../../bin/goalert",
        "BASE_URL=http://localhost:$PROXY_PORT"
      ],
      "Before": {
        "Before": {
          "Name": "PG Wait",
          "Command": ["bin/waitfor", "$DB_AUTH_URL"]
        },
        "Name": "MakeDB",
        "Command": [
          "psql",
          "-d",
          "$DB_AUTH_URL",
          "-c",
          "create database $DB_NAME;"
        ]
      }
    },
    "Command": [
      "bin/goalert",
      "-l=localhost:$GOALERT_PORT",
      "--db-url=$DB_URL",
      "--log-requests=false",
      "--slack-base-url=http://localhost:$PROXY_PORT/slack"
    ]
  },
  {
    "Name": "Slack",
    "Command": [
      "bin/mockslack",
      "-client-id=000000000000.000000000000",
      "-client-secret=00000000000000000000000000000000",
      "-access-token=xoxp-000000000000-000000000000-000000000000-00000000000000000000000000000000",
      "-prefix=/slack",
      "-single-user=bob",
      "-addr=localhost:$SLACK_PORT"
    ]
  },
  {
    "Name": "Proxy",
    "Command": [
      "bin/simpleproxy",
      "-addr=localhost:$PROXY_PORT",
      "/slack/=http://localhost:$SLACK_PORT",
      "http://localhost:$GOALERT_PORT"
    ]
  },
  {
    "Name": "Cypress",
    "Before": {
      "Name": "BE Wait",
      "Command": ["bin/waitfor", "http://localhost:$GOALERT_PORT"]
    },
    "Command": [
      "./node_modules/.bin/cypress",
      "run",
      "--config",
      "baseUrl=http://localhost:$PROXY_PORT"
    ],
    "Env": ["CYPRESS_DB_URL=$DB_URL"],
    "Dir": "web/src",
    "ExitAfter": true
  }
]
